#!/usr/bin/env bash

configure_nginx()
{
  (
  enter "${install_path}"
  ensure_paths_exist "${nginx_dirs[@]}"

  enter "${install_path}/etc/nginx"
  ensure_paths_exist "${config_dirs[@]}"
  )

  (
  # Cleanup default nginx install messy directory.
  enter "${install_path}/etc/nginx"
  move_files to "${install_path}/etc/nginx/conf" "${nginx_files[@]}"
  )

  ensure_paths_exist "${active_path}/config" "${active_path}/etc/nginx/servers"

  install_template "nginx.conf" to "${active_path}/etc/nginx/nginx.conf" \
    mode 0644 owner "${service_user}"

  install_template "nginx" to "${init_scripts_path}/etc/nginx" \
    mode 0755 owner "${service_user}"

  templates=( "mime.types" "proxy.conf" )
  for template in "${templates[@]}"
  do
    install_template "${template}" to "${active_path}/etc/nginx/conf/${template}" \
      mode 0644 owner "${service_user}"
  done

  user_create_if_missing "nginx" with group "nginx"

  if user_is_root
  then
    if (( ${force_flag:-0} == 1 ))
    then
      remove_paths "/etc/nginx"
    fi

    if ! file_exists "/etc/nginx/nginx.conf"
    then
      link --force "${active_path}/etc/nginx" "/etc/nginx"
    fi
    link --force "${active_path}/sbin/nginx" to "/usr/sbin/nginx"
  fi

  (
  enter "${install_path}"

  chown_paths_recursively "nginx:nginx" "${nginx_dirs[@]}" \
    "${install_path}/etc/nginx" "${active_path}/etc/nginx"
  )
}
